<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ä¸“ä¸šè°ƒè¯•ç»ˆç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ca8a04;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.5; height: 100vh; box-sizing: border-box; overflow: hidden; /* é˜²æ­¢ Body æ»šåŠ¨ */ }

        /* æ ¸å¿ƒå¸ƒå±€ä¿®å¤ï¼šé™åˆ¶é«˜åº¦ï¼Œç¦æ­¢æº¢å‡º */
        .app-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: 100%; /* å æ»¡çˆ¶å®¹å™¨ */
            overflow: hidden; /* å…³é”®ï¼šç¦æ­¢ Grid æœ¬èº«è¢«æ’‘å¤§ */
        }
        @media (max-width: 800px) { .app-grid { grid-template-columns: 1fr; height: auto; overflow-y: auto; } }

        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); flex-shrink: 0; /* é˜²æ­¢å¡ç‰‡è¢«æŒ¤å‹ */ }
        h3 { margin-top: 0; font-size: 16px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: border 0.2s; }
        input:focus { outline: none; border-color: var(--primary); }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-sm { padding: 5px 10px; font-size: 12px; flex: initial; }

        .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; }
        .status-connected { background: #dcfce7; color: #166534; }
        .status-disconnected { background: #fee2e2; color: #991b1b; }
        .led { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-connected .led { background: #166534; box-shadow: 0 0 5px #166534; }
        .status-disconnected .led { background: #991b1b; }

        .sub-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .sub-dest { font-family: monospace; font-weight: bold; color: var(--primary); font-size: 13px; }

        /* --- ä¿®å¤å³ä¾§åˆ—å¸ƒå±€ --- */
        .right-column {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-width: 0; /* å…³é”®ä¿®å¤ï¼šå…è®¸ Flex å­é¡¹ç¼©å°ï¼Œé˜²æ­¢è¢«é•¿æ–‡æœ¬æ’‘å®½ */
            overflow: hidden; /* å…³é”®ä¿®å¤ï¼šé˜²æ­¢å†…å®¹æº¢å‡ºçˆ¶å®¹å™¨ */
        }

        .console-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0; /* å…³é”®ä¿®å¤ï¼šå…è®¸é«˜åº¦ç¼©å° */
            overflow: hidden;
        }

        .console-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }

        .log-box {
            flex: 1;
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            min-height: 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            border: 1px solid #333;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid #333;
            display: none;
            /* å…³é”®ä¿®å¤ï¼šé•¿å­—ç¬¦ä¸²å¼ºåˆ¶æ¢è¡Œ */
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
        }
        .log-entry.show { display: block; }
        .log-meta { color: #569cd6; margin-right: 8px; font-size: 11px; opacity: 0.7; }

        .c-debug { color: #808080; }
        .c-info { color: #d4d4d4; }
        .c-warn { color: #cca700; }
        .c-error { color: #f48771; }
        .c-success { color: #89d185; }
        .c-in { color: #4ec9b0; }
        .c-out { color: #ce9178; }
    </style>
</head>
<body>

<div class="app-grid">
    <div class="sidebar">
        <div class="card">
            <h3>
                <span>ğŸ”Œ è¿æ¥é…ç½®</span>
                <div id="statusBadge" class="status-badge status-disconnected">
                    <span class="led"></span> <span id="statusText">æœªè¿æ¥</span>
                </div>
            </h3>
            <div class="form-group">
                <label>WS åœ°å€</label>
                <input type="text" id="wsUrl" value="ws://localhost:7049/message/ws">
            </div>
            <div class="form-group">
                <label>Token (JWT)</label>
                <input type="password" id="wsToken" placeholder="Bearer Token..." value="">
            </div>
            <div class="btn-group">
                <button onclick="app.connect()" class="btn-primary" id="btnConnect">è¿æ¥</button>
                <button onclick="app.disconnect()" class="btn-danger" id="btnDisconnect" disabled>æ–­å¼€</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“¡ é¢‘é“è®¢é˜…ç®¡ç†</h3>
            <div class="form-group">
                <label>Destination (Topic/Queue)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="subDest" placeholder="/topic/public" value="/topic/test">
                    <button onclick="app.addSubscription()" class="btn-success btn-sm" style="width: 60px;">+ è®¢é˜…</button>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label>å·²è®¢é˜…é¢‘é“:</label>
                <div id="emptySubHint" style="font-size: 12px; color: #999; text-align: center; padding: 10px;">æš‚æ— è®¢é˜…</div>
                <ul id="subList" class="sub-list">
                </ul>
            </div>
        </div>
    </div>

    <div class="right-column">
        <div class="card">
            <h3>ğŸ“¨ å‘é€æ¶ˆæ¯è°ƒè¯•</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>ç›®æ ‡åœ°å€ (Destination)</label>
                    <input type="text" id="sendDest" value="/app/test">
                </div>
                <div class="form-group">
                    <label>è´Ÿè½½å†…å®¹ (JSON)</label>
                    <input type="text" id="sendBody" value='{"msg": "hello"}'>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 5px;">
                <button onclick="app.sendMessage()" class="btn-primary">å‘é€æ¶ˆæ¯</button>
            </div>
        </div>

        <div class="card console-container">
            <div class="console-toolbar">
                <h3>ğŸ–¥ï¸ å®æ—¶æ—¥å¿—</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="margin:0; font-weight: normal;">æ—¥å¿—è¿‡æ»¤:</label>
                    <select id="logLevel" onchange="app.changeLogLevel()" style="padding: 4px; width: 100px;">
                        <option value="0">å…¨éƒ¨ (Debug)</option>
                        <option value="1" selected>å¸¸è§„ (Info)</option>
                        <option value="2">è­¦å‘Š (Warn)</option>
                        <option value="3">ä»…é”™è¯¯ (Error)</option>
                    </select>
                    <button onclick="app.clearLog()" class="btn-sm" style="background: #475569;">æ¸…ç©º</button>
                </div>
            </div>
            <div id="logBox" class="log-box">
                <div class="log-entry show"><span class="log-meta">[System]</span> <span class="c-info">æ§åˆ¶å°å‡†å¤‡å°±ç»ª...</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    const LOG_LEVEL = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 };

    class WebSocketService {
        constructor() {
            this.client = null;
            this.isConnected = false;
            this.token = null;
            this.messageQueue = [];
            this.activeSubscriptions = new Map();
            this._initVisibilityListener();
        }

        _initVisibilityListener() {
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    logger.debug('ğŸ‘€ é¡µé¢å›åˆ°å‰å°ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€...');
                    if (!this.isConnected && this.client && this.token) {
                        logger.warn('âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œé˜²æ–­è¿æœºåˆ¶è§¦å‘ï¼Œå°è¯•é‡è¿...');
                        this.client.activate();
                    }
                } else {
                    logger.debug('ğŸ˜´ é¡µé¢åˆ‡æ¢åˆ°åå° (Tab Hidden)');
                }
            });
        }

        connect(config) {
            if (this.isConnected) return;
            this.token = config.token;

            this.client = new StompJs.Client({
                brokerURL: config.url,
                connectHeaders: {
                    Authorization: `Bearer ${config.token}`
                    // User ID å·²å®Œå…¨ç§»é™¤
                },
                heartbeatIncoming: 20000,
                heartbeatOutgoing: 20000,
                reconnectDelay: 5000,
                debug: (str) => {
                    if (!str.includes('PING') && !str.includes('PONG')) logger.debug(`[Stomp] ${str}`);
                },
                onConnect: () => {
                    this.isConnected = true;
                    app.updateStatusUI(true);
                    logger.success('ğŸ‰ WebSocket è¿æ¥æˆåŠŸ!');
                    this._flushMessageQueue();
                    this._resubscribeAll();
                },
                onStompError: (frame) => {
                    logger.error(`åè®®é”™è¯¯: ${frame.headers['message']}`);
                },
                onWebSocketClose: () => {
                    this.isConnected = false;
                    app.updateStatusUI(false);
                    logger.warn('ğŸ”Œ è¿æ¥æ–­å¼€ (ç­‰å¾…è‡ªåŠ¨é‡è¿...)');
                }
            });

            logger.info(`ğŸš€ å¼€å§‹è¿æ¥: ${config.url}...`);
            this.client.activate();
        }

        subscribe(destination) {
            if (this.activeSubscriptions.has(destination)) {
                logger.warn(`é‡å¤è®¢é˜…: ${destination}`);
                return;
            }
            const subInfo = { destination, subObj: null };
            if (this.isConnected && this.client) {
                subInfo.subObj = this._doStompSubscribe(destination);
            } else {
                logger.info(`ğŸ“ å·²è®°å½•è®¢é˜… (ç­‰å¾…è¿æ¥åç”Ÿæ•ˆ): ${destination}`);
            }
            this.activeSubscriptions.set(destination, subInfo);
            app.renderSubList();
        }

        _doStompSubscribe(destination) {
            const sub = this.client.subscribe(destination, (msg) => {
                logger.incoming(`æ”¶åˆ° [${destination}]: ${msg.body}`);
            });
            logger.success(`âœ… è®¢é˜…æˆåŠŸ: ${destination}`);
            return sub;
        }

        unsubscribe(destination) {
            const info = this.activeSubscriptions.get(destination);
            if (info) {
                if (info.subObj) info.subObj.unsubscribe();
                this.activeSubscriptions.delete(destination);
                logger.info(`ğŸ—‘ï¸ å·²å–æ¶ˆè®¢é˜…: ${destination}`);
                app.renderSubList();
            }
        }

        _resubscribeAll() {
            if (this.activeSubscriptions.size === 0) return;
            logger.info(`ğŸ”„ æ­£åœ¨æ¢å¤ ${this.activeSubscriptions.size} ä¸ªè®¢é˜…...`);
            this.activeSubscriptions.forEach((info, dest) => {
                info.subObj = this._doStompSubscribe(dest);
            });
        }

        send(destination, bodyObj) {
            const body = JSON.stringify(bodyObj);
            if (this.client && this.isConnected) {
                this.client.publish({ destination, body });
                logger.outgoing(`å‘é€è‡³ [${destination}]: ${body}`);
            } else {
                this.messageQueue.push({ destination, body });
                logger.warn(`ğŸ›‘ æœªè¿æ¥ï¼Œæ¶ˆæ¯å·²ç¼“å†² (${this.messageQueue.length})`);
            }
        }

        _flushMessageQueue() {
            while (this.messageQueue.length > 0) {
                const item = this.messageQueue.shift();
                this.client.publish(item);
                logger.success(`ğŸš€ è¡¥å‘æ¶ˆæ¯: ${item.destination}`);
            }
        }

        disconnect() {
            if (this.client) this.client.deactivate();
            this.isConnected = false;
            this.activeSubscriptions.clear();
            this.messageQueue = [];
            app.updateStatusUI(false);
            app.renderSubList();
            logger.error('ğŸ›‘ å·²ä¸»åŠ¨æ–­å¼€è¿æ¥');
        }
    }

    const wsService = new WebSocketService();

    const app = {
        connect: () => {
            const url = document.getElementById('wsUrl').value;
            const token = document.getElementById('wsToken').value;

            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnDisconnect').disabled = false;

            wsService.connect({ url, token });
        },

        disconnect: () => {
            wsService.disconnect();
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnDisconnect').disabled = true;
        },

        updateStatusUI: (isConnected) => {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            if (isConnected) {
                badge.className = 'status-badge status-connected';
                text.innerText = 'å·²è¿æ¥';
            } else {
                badge.className = 'status-badge status-disconnected';
                text.innerText = 'æœªè¿æ¥';
            }
        },

        addSubscription: () => {
            const dest = document.getElementById('subDest').value;
            if (!dest) return;
            wsService.subscribe(dest);
        },

        removeSubscription: (dest) => {
            wsService.unsubscribe(dest);
        },

        renderSubList: () => {
            const listEl = document.getElementById('subList');
            const emptyHint = document.getElementById('emptySubHint');
            listEl.innerHTML = '';

            if (wsService.activeSubscriptions.size === 0) {
                emptyHint.style.display = 'block';
                return;
            }

            emptyHint.style.display = 'none';
            wsService.activeSubscriptions.forEach((val, key) => {
                const li = document.createElement('li');
                li.className = 'sub-item';
                li.innerHTML = `
                <div>
                    <div class="sub-dest">${key}</div>
                    <div class="sub-id" style="font-size:11px; color:#666">çŠ¶æ€: ${wsService.isConnected ? 'ç›‘å¬ä¸­ ğŸŸ¢' : 'ç­‰å¾…è¿æ¥ ğŸŸ¡'}</div>
                </div>
                <button class="btn-danger btn-sm" onclick="app.removeSubscription('${key}')">å–æ¶ˆ</button>
            `;
                listEl.appendChild(li);
            });
        },

        sendMessage: () => {
            const dest = document.getElementById('sendDest').value;
            const bodyStr = document.getElementById('sendBody').value;
            try {
                const body = JSON.parse(bodyStr);
                wsService.send(dest, body);
            } catch (e) {
                logger.error('JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
            }
        },

        changeLogLevel: () => {
            const level = parseInt(document.getElementById('logLevel').value);
            logger.currentLevel = level;
            logger.refreshVisibility();
        },

        clearLog: () => {
            document.getElementById('logBox').innerHTML = '';
        }
    };

    const logger = {
        currentLevel: 1,

        _write: (msg, type, levelVal) => {
            const box = document.getElementById('logBox');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.dataset.level = levelVal;

            if (levelVal >= logger.currentLevel) {
                div.classList.add('show');
            }

            const time = new Date().toLocaleTimeString();
            let colorClass = 'c-info';
            let icon = 'â„¹ï¸';

            switch(type) {
                case 'debug': colorClass = 'c-debug'; icon = 'ğŸ'; break;
                case 'info': colorClass = 'c-info'; icon = 'â„¹ï¸'; break;
                case 'warn': colorClass = 'c-warn'; icon = 'âš ï¸'; break;
                case 'error': colorClass = 'c-error'; icon = 'âŒ'; break;
                case 'success': colorClass = 'c-success'; icon = 'âœ…'; break;
                case 'in': colorClass = 'c-in'; icon = 'ğŸ“¥'; break;
                case 'out': colorClass = 'c-out'; icon = 'ğŸ“¤'; break;
            }

            div.innerHTML = `<span class="log-meta">[${time}]</span> <span class="${colorClass}">${icon} ${msg}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        },

        refreshVisibility: () => {
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                const entryLevel = parseInt(entry.dataset.level);
                if (entryLevel >= logger.currentLevel) {
                    entry.classList.add('show');
                } else {
                    entry.classList.remove('show');
                }
            });
        },

        debug: (msg) => logger._write(msg, 'debug', LOG_LEVEL.DEBUG),
        info: (msg) => logger._write(msg, 'info', LOG_LEVEL.INFO),
        warn: (msg) => logger._write(msg, 'warn', LOG_LEVEL.WARN),
        error: (msg) => logger._write(msg, 'error', LOG_LEVEL.ERROR),
        success: (msg) => logger._write(msg, 'success', LOG_LEVEL.INFO),
        incoming: (msg) => logger._write(msg, 'in', LOG_LEVEL.INFO),
        outgoing: (msg) => logger._write(msg, 'out', LOG_LEVEL.INFO)
    };
</script>

</body>
</html>